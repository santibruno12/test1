# Cobro de facturas

##### Otra funcion que cumplen nuestros metodos son los "Cobros de facturas", Para esto utilizaremos el metodo " /sales/billPayment/ " modificandolo para cada accion que queremos hacer



#
##  Obtener las empresas disponibles

El metodo "/sales/billPayment/availablesCompanies" sirve para obtener todas las empresas habilitadas para operar. Estas poseen una estructura la cual veremos a continuacion.

### Estructura de una compañia
Como datos importantes podemos encontrar:

Dato | Descripcion | 
---------|----------|
 id | Identificador interno |
 name/description | Nombre de la empresa |
 code | Codigo de la empresa |
 enable | Habilitado o desabilitado | 
 externalName | Nombre que deben usar para referirse a la empresa cuando se le muestre al usuario | 
 allowVoluntaryAmount | Sera deprecado, no usar mas | 
 allowBillManualPayment | True = la empresa soportara que se busquen facturas por datos manuales (por factura) | 
 allowBillRelationPayment | True = la empresa soportara buscar facturas por codigo de barra | 
 allowPartialAmount| True =  El monto de cualquier factura recuperada podra ser modificado  | 
 customerIdentifierDescription | Sera deprecado, no usar mas | 
 billMode | El BillMode representa cada convenio de pago que tiene la empresa y son los diferentes servicios que pueden ser administrados por la empresa seleccionada. El "id" es el identificador del tipo de convenio y el "name" el nombre del mismo.| 
 parameters | Cada convenio de la factura tiene diferentes parametros para solicitar al usuario. Estos parametros se explicaran en la siguiente tabla | 





**Estructura de los parametros**

 Dato | Descripcion | 
---------|----------|
 id | identificador del parametro a solicitar | 
 name | Nombre del dato a solicitar | 
 inputTipe | Identifica el tipo de dato q solicita. T para alfanumerico. N para numerico entero. I para decimal. D para dato de fecha | 
 order | Orden del parametro que se pide al usuario | 
 length | Caracteres maximos permitidos en el dato  | 
 readOnly | True = los datos no pueden ser editados (se utiliza en casos donde los parametros sean default siempre y no puedan tocarse)  | 
 optional | Es un dato especifico que puede pedir la empresa  | 

```json
{
    "id": "16CB1F68156830E1CC92",
    "description": "CIMES AGUA",
    "name": "CIMES AGUA",
    "code": "9312",
    "enable": true,
    "externalName": "CIMES AGUA",
    "allowVoluntaryAmount": false,
    "allowBillManualPayment": true,
    "allowBillRelationPayment": true,
    "allowPartialAmount": false,
    "customerIdentifierDescription": "NUMERO DE CUIT",
    "billModes": [
        {
            "billMode": {
                "id": "1811231643dfVbFIjorX",
                "name": "COBRANZA SIN FACTURA (CONSULTA DE DEUDA)"
            },
            "parameters": [
                {
                    "id": "CBF",
                    "name": "NUMERO DE CUIT",
                    "inputType": "T",
                    "order": 0,
                    "length": 19,
                    "readOnly": false,
                    "optional": false
                }
            ]
        }
    ]
},
```


## Obtener Factura por codigo de barras

La obtencion de este es muy sencilla. Utilizar un POST en el metodo /sales/billPayment/availablesBill/findByBarCode. El body requerido en el request pide el dato "billBarCode" con un codigo de barras como en el siguiente ejemplo.

```json
{
    "billBarCode": "579201910127747008036409003400000101000004270050"    
}
```
Para este metodo hay 3 casos posibles de reponse.


### 1- Encuentra la factura correctamente 
El primero caso es cuando la factura es encontrada y muestra su estructura de factura correctamente

```json
[
    {
        "className": "BillPaymentData",
        "externalData": "93A1028111DA001249707347xxxxxxxxxxx1xxxxxxxxx0C0602C0C0C0C0",
        "billCompany": {
            "id": "16CB1F6815771858E95F",
            "description": "DIRECT TV",
            "name": "DIRECT TV",
            "code": "57",
            "enable": true,
            "externalName": "DIRECT TV",
            "allowVoluntaryAmount": false,
            "allowBillManualPayment": true,
            "allowBillRelationPayment": true,
            "allowPartialAmount": false,
            "customerIdentifierDescription": "Nro. de Cliente",
            "billModes": [
                {
                    "billMode": {
                        "id": "61953167179400013610",
                        "name": "COBRANZA SIN FACTURA 10 D"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro. de Cliente",
                            "inputType": "T",
                            "order": 0,
                            "length": 10,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                },
                {
                    "billMode": {
                        "id": "46505976008500000337",
                        "name": "COBRANZA SIN FACTURA (ONLINE)"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro. de Cliente",
                            "inputType": "T",
                            "order": 0,
                            "length": 8,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                },
                {
                    "billMode": {
                        "id": "0812030936xfRlxsGlAx",
                        "name": "COBRANZA SIN FACTURA"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro. de Cliente",
                            "inputType": "T",
                            "order": 0,
                            "length": 8,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                }
            ]
        },
        "currencyIso": "ARS",
        "customerIdentifier": "0086108279",
        "billBarCode": "05700861082790003832152882102060000027480005",
        "description": "Cliente: 0086108279\n",
        "totalAmount": 2748.00,
        "openAmount": false,
        "requireAditionalData": false,
        "aditionalData": [],
        "minAmount": 2748.00,
        "maxAmount": 2748.00
    }
]
```





### 2- No encuentra factura

Este caso ocurre cuando el metodo no encuentra una factura devolviendo una respuesta vacia



### 3- Los datos no alcanzan para determinar la factura
En este caso el codigo de barras ingresado trae facturas de varias empresas y no alcanza para determinar cual es la correcta a pagar, si se da este suceso deberiamos especificar de la siguiente manera.


```json
{
    "billBarCode": "579201910127747008036409003400000101000004270050",
    "billCompany": {
            "code": "3145"
        }
}
```


Dicho code, lo obtendriamos del metodo "/sales/billPayment/availablesCompanies" en el dato "code" de la compañia que vamos a utilizar





## Obtener por datos de Factura


La segunda forma de obtener una factura es a traves de datos ingresados sobre la factura y la compañia a utilizar. 
Este metodo exige escribir varios datos dentro del body para poder ejecutar el metodo correctamente.

• En primera instancia un objeto "billCompany" el cual contiene un codigo de la empresa a utilizar. 

• Luego un "billMode" el cual determina el tipo de factura que se desea obtener, este contiene un "id" con el codigo del tipo de factura y un "name" que contiene el nombre del tipo de factura. 

• Por ultimo el parametro el cual define el "value" ????




```json
{
	"billCompany": {
		"code": "482"
	},
	"billMode": {
		"id": "39030785707000000527",
		"name": "COBRANZA SIN FACTURA - CUIT / DNI"
	},
	"parameters": [
		{
			"id": "C11",
			"value": "27249286090"
		}
	]
}
```

### 1- Encuentra la factura correctamente 
El primero caso es cuando la factura es encontrada y muestra su estructura de factura correctamente

```json
[
    {
        "className": "BillPaymentData",
        "externalData": "93A1028111DA001249707347xxxxxxxxxxxxxxxxxxxxx0C0602C0C0C0C0",
        "billCompany": {
            "id": "16CB1F6815771858E95F",
            "description": "DIRECT TV",
            "name": "DIRECT TV",
            "code": "57",
            "enable": true,
            "externalName": "DIRECT TV",
            "allowVoluntaryAmount": false,
            "allowBillManualPayment": true,
            "allowBillRelationPayment": true,
            "allowPartialAmount": false,
            "customerIdentifierDescription": "Nro. de Cliente",
            "billModes": [
                {
                    "billMode": {
                        "id": "61953167179400013610",
                        "name": "COBRANZA SIN FACTURA 10 D"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro. de Cliente",
                            "inputType": "T",
                            "order": 0,
                            "length": 10,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                },
                {
                    "billMode": {
                        "id": "46505976008500000337",
                        "name": "COBRANZA SIN FACTURA (ONLINE)"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro. de Cliente",
                            "inputType": "T",
                            "order": 0,
                            "length": 8,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                },
                {
                    "billMode": {
                        "id": "0812030936xfRlxsGlAx",
                        "name": "COBRANZA SIN FACTURA"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro. de Cliente",
                            "inputType": "T",
                            "order": 0,
                            "length": 8,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                }
            ]
        },
        "currencyIso": "ARS",
        "customerIdentifier": "0086108279",
        "billBarCode": "05700861082790003832152882102060000027480005",
        "description": "Cliente: 0086108279\n",
        "totalAmount": 2748.00,
        "openAmount": false,
        "requireAditionalData": false,
        "aditionalData": [],
        "minAmount": 2748.00,
        "maxAmount": 2748.00
    }
]
```





### 2- No encuentra factura

Este caso ocurre cuando el metodo no encuentra una factura devolviendo una respuesta vacia


## Estructura de una factura



Dato | Descripcion | 
---------|----------|
 className  | tag que define la transaccion a utilizar |
 externalData | Es un tag que debe ser utilizado (sin modificarlo) en el metodo de pago de factura, Este hace unica y pagable a la factura |
 billCompany | Es la empresa a la que remite la factura | 
 currency | Es la moneda en la que se expresa la factura en modo ISO | 
 customerIdentifier | Es el numero que identifica al cliente de la factura, este dato puede variar dependiendo la empresa | 
 billBarCode | Es el codigo de barra de la factura (si lo posee) | 
 description | Texto que explica la facutra (depende de cada empresa) | 
 totalAmount | Monto a pagar | 
 openAmount | True = El valor puede ser modificado | 
 minAmount/maxAmount | Si puede ser modificado, estos son los rangos soportados | 
 






## Abonar una Factura

Para abonar una factura se deberia usar un POST con el metodo /sales/billPayment/. 

### Request
Para este metodo enviaremos el siguiente REQUEST:
```json
{
    "transactionType": "Sale",
    "amount": 50,
    "clientTransactionId": "b623a420-bddb-49e7-9ea6-aca7261111124",
    "product": {
        "id": "16CB1F68157735D21E5D"
    },
    "transactionData": {
        "className": "BillPaymentData",
        "externalData": "93A1028111DA0012497073477643454461746F7353616C69646181DC0013A76"
    }
}
```


Dato | Descripcion | 
---------|----------|
 transactionType  | Tipo de transaccion |
 amount | Monto a abonar |
 clientTransactionId | Nro de transaccion (debe ser unico) | 
 product  | En el caso de las facturas, el producto hace referencia a la empresa y debe enviarse su respectivo ID| 
 transactionData | Este dato es el cual se envia para identificar la factura, esto se realiza con el externalData el cual obtenemos anteriormente con los metodos de busqueda |



### Response

El estado final de cada transacción no debe ser asumido por el cliente. Siempre debe ser informado por Traxion siendo el único estado final válido. Luego de ser enviada la solicitud de Pago de factura si la respuesta no es recibida dentro de los 60 segundos inmediatos se debe proceder con el envío de consulta de estado hasta recibir su obtención final (ver **Obtener estado de la transacción**). Ya sea por el timeout sugerido, o por cualquier error de otra naturaleza, siempre se debe utilizar el servicio de consulta de estado de transacción (con id de la transaccion), hasta que la plataforma informe el estado final real.

Los estados finales de una transacción son **aprobado** y **rechazado**

**Ejemplo Response con estado aprobado**

```json
{
    "id": "2C497E4E3265307AC61A",
    "number": 743698523,
    "created": "2021-05-18T13:20:20-03:00",
    "confirmationDate": "2021-05-18T13:20:31-03:00",
    "amount": 50.00,
    "description": "Pago Servicio - 743698523",
    "state": "approved",
    "stateDetail": {
        "message": "Confirmada",
        "transactionType": "Sale"
    },
    "transactionType": "Sale",
    "clientTransactionId": "b623a420ea6-aca7261111124",
    "confirmationId": "207293507402358",
    "product": {
        "id": "7F1128557A1717E829B6",
        "name": "Cobro de Servicios",
        "code": "002224",
        "enable": true,
        "smallDescription": "Cobro Serv.",
        "vendor": {
            "id": "3B2675DEEF7B2F9132D6",
            "description": "Traxion",
            "name": "Traxion",
            "code": "007087",
            "enable": true
        },
        "productGroup": {
            "id": "59846EDCFCAE0E47FF5E",
            "description": "Cobros",
            "name": "Cobros",
            "code": "010979",
            "enable": true
        },
        "minimium": 1,
        "maximium": 1000000,
        "productType": "BillPayment",
        "transactionDataClassName": "WithoutData",
        "salePrice": 0.00000000
    },
    "transactionData": {
        "className": "BillPaymentData",
        "externalData": "93A1028111DA0012497073477643454461746F7353616C69646181DC0014A7696D706A",
        "billCompany": {
            "id": "16CB1F68157735D21E5D",
            "description": "GAM SALUD S.A.",
            "name": "GAM SALUD S.A.",
            "code": "1195",
            "enable": false,
            "externalName": "GAM SALUD S.A.",
            "allowVoluntaryAmount": false,
            "allowBillManualPayment": true,
            "allowBillRelationPayment": true,
            "allowPartialAmount": false,
            "customerIdentifierDescription": "Nro Afiliado",
            "billModes": [
                {
                    "billMode": {
                        "id": "0812030936XmIFLDpZsV",
                        "name": "COBRANZA SIN FACTURA"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro Afiliado",
                            "inputType": "T",
                            "order": 0,
                            "length": 10,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                }
            ]
        },
        "currencyIso": "ARS",
        "customerIdentifier": "0052256",
        "billBarCode": "0052256037008554",
        "description": "Cliente: 0052256\n",
        "totalAmount": 50.00,
        "openAmount": true,
        "requireAditionalData": false,
        "aditionalData": [],
        "minAmount": 37.00,
        "maxAmount": 999999.00
    }
}
```

**Ejemplo Response con estado rechazado**

En el caso del estado de **anulada/rechazado** se enviará en el response el motivo de rechazo.


```json
{
    "id": "2C497E4E36CD23A793EA",
    "number": 743698526,
    "created": "2021-05-18T13:25:49-03:00",
    "amount": 50.00,
    "description": "Pago Servicio - 743698526",
    "state": "rejected",
    "stateDetail": {
        "message": "409_BILL_ALREADY_PAID - Factura con barra: 0052256037008554 y código de empresa: 1195 ya ha sido pagada. Id de operación: 60a3e958eb87f2075ae9271a",
        "transactionType": "Sale"
    },
    "transactionType": "Sale",
    "clientTransactionId": "b623a420ea6-aca72124",
    "confirmationId": "",
    "product": {
        "id": "7F1128557A1717E829B6",
        "name": "Cobro de Servicios",
        "code": "002224",
        "enable": true,
        "smallDescription": "Cobro Serv.",
        "vendor": {
            "id": "3B2675DEEF7B2F9132D6",
            "description": "Traxion",
            "name": "Traxion",
            "code": "007087",
            "enable": true
        },
        "productGroup": {
            "id": "59846EDCFCAE0E47FF5E",
            "description": "Cobros",
            "name": "Cobros",
            "code": "010979",
            "enable": true
        },
        "minimium": 1,
        "maximium": 1000000,
        "productType": "BillPayment",
        "transactionDataClassName": "WithoutData",
        "salePrice": 0.00000000
    },
    "transactionData": {
        "className": "BillPaymentData",
        "externalData": "93A1028111DA0012497073477643454461746F7353616C69646181DC0014A7696D706F727465AB63",
        "billCompany": {
            "id": "16CB1F68157735D21E5D",
            "description": "GAM SALUD S.A.",
            "name": "GAM SALUD S.A.",
            "code": "1195",
            "enable": false,
            "externalName": "GAM SALUD S.A.",
            "allowVoluntaryAmount": false,
            "allowBillManualPayment": true,
            "allowBillRelationPayment": true,
            "allowPartialAmount": false,
            "customerIdentifierDescription": "Nro Afiliado",
            "billModes": [
                {
                    "billMode": {
                        "id": "0812030936XmIFLDpZsV",
                        "name": "COBRANZA SIN FACTURA"
                    },
                    "parameters": [
                        {
                            "id": "CBF",
                            "name": "Nro Afiliado",
                            "inputType": "T",
                            "order": 0,
                            "length": 10,
                            "readOnly": false,
                            "optional": false
                        }
                    ]
                }
            ]
        },
        "currencyIso": "ARS",
        "customerIdentifier": "0052256",
        "billBarCode": "0052256037008554",
        "description": "Cliente: 0052256\n",
        "totalAmount": 50.00,
        "openAmount": true,
        "requireAditionalData": false,
        "aditionalData": [],
        "minAmount": 37.00,
        "maxAmount": 999999.00
    }
}
```


Por último, si el response devuelve el estado **pendiente** se deberá enviar la consulta de estado hasta obtener en el response un estado final (rechazada o aprobada).
Esto se realizará con el metodo [/sale/{id}](https://apidoc.traxion.com.ar/docs/Documentacion/swagger.yaml/paths/~1sale~1%7Bid%7D/get) el cual se especifica en "[Obtener Estado de la transaccion](???)"



## Obtener recibo de la transacción

Para obtener el recibo de la transacción se deberá utilizar el método [/sale/{id}/receipt](https://apidoc.traxion.com.ar/docs/Documentacion/swagger.yaml/paths/~1sale~1%7Bid%7D~1receipt/get) enviando el ID de la transacción de la siguiente forma: ** /sale/2D06714504BD3B177843/receipt**.
 El ID de la transacción se obtiene del response de la transacción de pago de factura. 



## Obtener Estado de la transacción

Para obtener el estado de la transacción se utiliza el método [/sale/{id}](https://apidoc.traxion.com.ar/docs/Documentacion/swagger.yaml/paths/~1sale~1%7Bid%7D/get) con el **ID de la transacción** obtenido en el response de pago de factura,


